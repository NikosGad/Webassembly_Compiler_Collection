version: "3"
services:
    adminer:
        image: adminer
        container_name: adminer
        ports:
            - "8000:8080"
    database:
        build:
            context: ./backend/database
            dockerfile: Dockerfile
        image: database:${IMAGE_VERSION}
        container_name: database-devel
        # user: ${APP_USER}
        environment:
            - POSTGRES_PASSWORD=example
            - POSTGRES_USER=database
    nginx:
        build:
            context: ./frontend/
            dockerfile: Dockerfile-nginx
        image: nginx:${IMAGE_VERSION}
        container_name: nginx
        ports:
            - "${FRONTEND_HOST_PORT}:${FRONTEND_CONTAINER_PORT}"
            - "${BACKEND_HOST_PORT}:${BACKEND_CONTAINER_PORT}"
        depends_on:
            - rest_server
    rest_server:
        build: ./backend/rest_server
        image: ${APP}:${IMAGE_VERSION}
        user: ${APP_USER}
        container_name: wasmcc
        environment:
            - UPLOAD_PATH_EMSCRIPTEN=${ROOT_RESULTS_DIR}/${EMSCRIPTEN}/
            - UPLOAD_PATH_GOLANG=${ROOT_RESULTS_DIR}/${GOLANG}/src/
            - GOOS=js
            - GOARCH=wasm
            - GOCACHE=${ROOT_RESULTS_DIR}/${GOLANG}/dev_tools/.cache/go-build
            - GOENV=${ROOT_RESULTS_DIR}/${GOLANG}/dev_tools/.config/go/env
            - GO_INSTALLATION_PATH=/usr/local/go/
        expose:
            - ${BACKEND_CONTAINER_PORT}
        volumes:
            - "${HOST_RESULTS_DIR_PREFIX}${ROOT_RESULTS_DIR}:${ROOT_RESULTS_DIR}"
        command: bash -c "uwsgi --ini /app/uwsgi.ini"
        depends_on:
            - database
